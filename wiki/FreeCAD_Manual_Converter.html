<link href="site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">FreeCAD Manual Converter</span></h1><?xml encoding="UTF-8"><div class="mw-parser-output"><div class="mw-pt-languages noprint" lang="en" dir="ltr"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><span class="mw-pt-languages-ui mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" lang="en" dir="ltr">English</span></li>
<li><a href="fr/FreeCAD_Manual_Converter.html" class="mw-pt-progress mw-pt-progress--complete" title="FreeCAD Manual Converter (100% translated)" lang="fr" dir="ltr">fran&ccedil;ais</a></li>
<li><a href="pl/FreeCAD_Manual_Converter.html" class="mw-pt-progress mw-pt-progress--complete" title="Konwerter Podr&#281;cznika FreeCAD (100% translated)" lang="pl" dir="ltr">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="index.php?title=Text-x-python.png&amp;filetimestamp=20121224162851&amp;.html" class="mw-file-description" title="Generic macro icon. Create your personal icon with the same name of the macro"><img alt="Generic macro icon. Create your personal icon with the same name of the macro" src="File/Text-x-python.png" decoding="async" width="32" height="32"></a></span><span> </span>
FreeCAD Manual Converter
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Python script that automatically generates PDF and EPUB versions of the FreeCAD manual.<br><br>Macro version: 0.1<br>Last modified: 2024-12-16<br>FreeCAD version: All<br>Author: Adrianos<br>
</td></tr>
<tr>
<th class="ctOdd">Author
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="index.php?title=User;Adrianos&amp;action=edit&amp;redlink=1.html" class="new" title="User:Adrianos (page does not exist)">Adrianos</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes">Macros recipes</a><br><a href="How_to_install_macros.html" title="How to install macros">How to install macros</a><br><a href="Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a>
</td></tr>
<tr>
<th class="ctOdd">Macro Version
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Date last modified
</th></tr>
<tr>
<td class="ctEven macro-date">2024-12-16
</td></tr>
<tr>
<th class="ctOdd">FreeCAD Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">All
</td></tr>
<tr>
<th class="ctOdd">Default shortcut
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">See also
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><meta property="mw:PageProp/toc">
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>The FreeCAD Manual Converter is a Python script that automatically generates PDF and EPUB versions of the FreeCAD manual from the FreeCAD Wiki. It creates a complete, properly formatted offline manual that includes all chapters, images, and formatting from the online manual.
</p>
<h3><span class="mw-headline" id="Background">Background</span></h3>
<p>The <a href="Manual;Introduction.html" title="Manual:Introduction">FreeCAD Manual</a> is a living document that continuously evolves thanks to the contributions of community members. While this makes it an excellent up-to-date resource, there are times when users need offline access to the manual or prefer to read it on e-readers and tablets. This script bridges that gap by allowing users to:
</p>
<ul><li>Generate an up-to-date offline copy of the manual at any time</li>
<li>Create both PDF and EPUB formats for different reading preferences</li>
<li>Include all the latest community contributions and updates</li>
<li>Maintain proper formatting and image quality</li>
<li>Have a complete reference even without internet access</li></ul>
<h2><span class="mw-headline" id="Dependencies">Dependencies</span></h2>
<h3><span class="mw-headline" id="Windows">Windows</span></h3>
<ol><li>Install Python 3.x.</li>
<li>Install GTK3 runtime</li>
<li>Open Command Prompt and install Python packages:</li></ol>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span> <span class="n">pip</span> <span class="n">install</span> <span class="n">requests</span> <span class="n">weasyprint</span> <span class="n">beautifulsoup4</span> <span class="n">PyPDF2</span> <span class="n">Pillow</span> <span class="n">cairosvg</span> <span class="n">ebooklib</span>
</pre></div>
<h3><span id="Linux_.28Ubuntu.2FDebian.29"></span><span class="mw-headline" id="Linux_(Ubuntu/Debian)">Linux (Ubuntu/Debian)</span></h3>
<p>Install all necessary dependencies as:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">python3</span><span class="o">-</span><span class="n">pip</span> <span class="n">python3</span><span class="o">-</span><span class="n">dev</span> <span class="n">python3</span><span class="o">-</span><span class="n">cairo</span> <span class="n">python3</span><span class="o">-</span><span class="n">gi</span><span class="o">-</span><span class="n">cairo</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">libcairo2</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpango1</span><span class="mf">.0</span><span class="o">-</span><span class="n">dev</span> <span class="n">libgdk</span><span class="o">-</span><span class="n">pixbuf2</span><span class="mf">.0</span><span class="o">-</span><span class="n">dev</span> <span class="n">libffi</span><span class="o">-</span><span class="n">dev</span> <span class="n">shared</span><span class="o">-</span><span class="n">mime</span><span class="o">-</span><span class="n">info</span>
</pre></div>
<p>and
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">requests</span> <span class="n">weasyprint</span> <span class="n">beautifulsoup4</span> <span class="n">PyPDF2</span> <span class="n">Pillow</span> <span class="n">cairosvg</span> <span class="n">ebooklib</span>
</pre></div>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<p>To use the script just download it and run it. The script will create two files in your current directory:
</p>
<ul><li><b>FreeCAD_User_Manual.pdf</b>: Complete PDF version of the manual</li>
<li><b>FreeCAD_User_Manual.epub</b>: EPUB version suitable for e-readers</li></ul>
<h2><span class="mw-headline" id="Script">Script</span></h2>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span> <span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">weasyprint</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="kn">import</span> <span class="n">PdfMerger</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">cairosvg</span>
<span class="kn">import</span> <span class="nn">ebooklib</span>
<span class="kn">from</span> <span class="nn">ebooklib</span> <span class="kn">import</span> <span class="n">epub</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">FreeCADManualConverter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_entries</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store chapter titles, subchapters, and hierarchy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chapters_html</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store HTML content for EPUB creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cache for deduplicating images</span>

    <span class="k">def</span> <span class="nf">optimize_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_url</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
        <span class="sd">"""Download and optimize a raster image."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">img_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">max_width</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">max_width</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">max_width</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">)),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"PNG"</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error optimizing image </span><span class="si">{</span><span class="n">img_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">svg_to_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">svg_url</span><span class="p">):</span>
        <span class="sd">"""Convert SVG to PNG."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svg_url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">cairosvg</span><span class="o">.</span><span class="n">svg2png</span><span class="p">(</span><span class="n">bytestring</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">output_width</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">output_height</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error converting SVG </span><span class="si">{</span><span class="n">svg_url</span><span class="si">}</span><span class="s2"> to PNG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_entries</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store chapter titles, subchapters, and hierarchy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chapters_html</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store HTML content for EPUB creation</span>

    <span class="k">def</span> <span class="nf">extract_manual_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">"https://wiki.freecad.org/Manual"</span><span class="p">):</span>
        <span class="sd">"""Extract all manual links and subchapters from the main Manual page."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fetching manual links from </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_page</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">html_content</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s1">'html.parser'</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Define unwanted languages</span>
        <span class="n">excluded_languages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'fr'</span><span class="p">,</span> <span class="s1">'de'</span><span class="p">,</span> <span class="s1">'es'</span><span class="p">,</span> <span class="s1">'hr'</span><span class="p">,</span> <span class="s1">'it'</span><span class="p">,</span> <span class="s1">'ko'</span><span class="p">,</span> <span class="s1">'pl'</span><span class="p">,</span> <span class="s1">'pt'</span><span class="p">,</span> <span class="s1">'ro'</span><span class="p">,</span> <span class="s1">'ru'</span><span class="p">,</span> <span class="s1">'zh'</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">a_tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">a_tag</span><span class="p">[</span><span class="s1">'href'</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="sa">f</span><span class="s2">"/</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s2">"</span> <span class="ow">in</span> <span class="n">href</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">excluded_languages</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">href</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'/Manual:'</span><span class="p">):</span>
                <span class="n">full_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"https://wiki.freecad.org</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">"</span>
                <span class="n">base_chapter</span> <span class="o">=</span> <span class="n">full_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">subchapter</span> <span class="o">=</span> <span class="n">full_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">'#'</span> <span class="ow">in</span> <span class="n">full_url</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">base_chapter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">links</span><span class="p">[</span><span class="n">base_chapter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_chapter</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">subchapter</span><span class="p">:</span>
                    <span class="n">links</span><span class="p">[</span><span class="n">base_chapter</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subchapter</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique manual links with subchapters."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">links</span>

    <span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">"""Fetch the HTML content of a given URL."""</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'/'</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"https://wiki.freecad.org</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to fetch </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. HTTP status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error fetching </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">extract_main_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html_content</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">chapter_title</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">):</span>
        <span class="sd">"""Extract content within the 'mw-parser-output' div, fix links, and process image paths."""</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s1">'html.parser'</span><span class="p">)</span>

        <span class="c1"># Remove unwanted elements</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'mw-pt-languages noprint'</span><span class="p">,</span> <span class="s1">'docnav'</span><span class="p">,</span> <span class="s1">'NavFrame'</span><span class="p">,</span> <span class="s1">'manualtoc'</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">class_</span><span class="o">=</span><span class="n">class_name</span><span class="p">):</span>
                <span class="n">element</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>

        <span class="n">main_content</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'div'</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s1">'mw-parser-output'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_content</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Main content ('mw-parser-output') not found."</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Add chapter title as heading at the top if not present</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">chapter_id</span><span class="p">):</span>
            <span class="n">heading_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">new_tag</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">chapter_id</span><span class="p">)</span>
            <span class="n">heading_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">chapter_title</span>
            <span class="n">main_content</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heading_tag</span><span class="p">)</span>

        <span class="c1"># Process images and store them for EPUB</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">main_content</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'img'</span><span class="p">):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'src'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'/'</span><span class="p">):</span>
                <span class="n">img_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">src</span><span class="si">}</span><span class="s2">"</span>
                <span class="n">img_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.svg'</span><span class="p">):</span>
                    <span class="c1"># Convert SVG to PNG</span>
                    <span class="n">png_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg_to_png</span><span class="p">(</span><span class="n">img_url</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">png_data</span><span class="p">:</span>
                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">png_data</span>
                        <span class="n">img_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">img_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.png"</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Optimize raster image</span>
                    <span class="n">img_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_image</span><span class="p">(</span><span class="n">img_url</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">img_data</span><span class="p">:</span>
                    <span class="c1"># For PDF</span>
                    <span class="n">img</span><span class="p">[</span><span class="s1">'src'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data:image/png;base64,</span><span class="si">{</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                    <span class="c1"># For EPUB - store reference</span>
                    <span class="n">img</span><span class="p">[</span><span class="s1">'epub_src'</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_filename</span>
                    <span class="n">img</span><span class="p">[</span><span class="s1">'epub_data'</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_data</span>

        <span class="c1"># Fix links</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">main_content</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'a'</span><span class="p">):</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'href'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">href</span> <span class="ow">and</span> <span class="n">href</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'/'</span><span class="p">):</span>
                <span class="n">link</span><span class="p">[</span><span class="s1">'href'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">href</span><span class="si">}</span><span class="s2">"</span>

        <span class="c1"># Store the HTML content for EPUB creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chapters_html</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'title'</span><span class="p">:</span> <span class="n">chapter_title</span><span class="p">,</span>
            <span class="s1">'id'</span><span class="p">:</span> <span class="n">chapter_id</span><span class="p">,</span>
            <span class="s1">'content'</span><span class="p">:</span> <span class="n">main_content</span><span class="p">,</span>
            <span class="s1">'number'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chapters_html</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_to_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">chapter_number</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">'pdfs'</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Processing </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">html_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">html_content</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s1">'html.parser'</span><span class="p">)</span>
        <span class="n">chapter_title</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" - "</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">soup</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="s2">"Chapter"</span>
        <span class="n">chapter_title</span> <span class="o">=</span> <span class="n">chapter_title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Manual:"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://wiki.freecad.org"</span>
        <span class="n">main_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_main_content</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">chapter_title</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_content</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

 
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">chapter_id</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toc_entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chapter_number</span><span class="p">,</span> <span class="n">chapter_title</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">))</span>

        <span class="n">styled_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">        &lt;head&gt;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">        body </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            margin: 20px;</span>
<span class="s2">            font-family: Arial, sans-serif;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        h1 </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            text-align: center;</span>
<span class="s2">            font-size: 24px;</span>
<span class="s2">            margin-bottom: 10px;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        h2 </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            font-size: 18px;</span>
<span class="s2">            margin-top: 10px;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        img </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            max-width: 100%;</span>
<span class="s2">            height: auto;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        code, pre </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            font-family: Consolas, "Courier New", monospace;</span>
<span class="s2">            font-size: 14px;</span>
<span class="s2">            background-color: #f4f4f4;</span>
<span class="s2">            padding: 10px;</span>
<span class="s2">            display: block;</span>
<span class="s2">            white-space: pre-wrap;</span>
<span class="s2">            word-wrap: break-word;</span>
<span class="s2">            overflow-x: auto;</span>
<span class="s2">            border: 1px solid #ddd;</span>
<span class="s2">            border-radius: 5px;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        .mw-highlight </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            padding: 10px;</span>
<span class="s2">            margin: 10px 0;</span>
<span class="s2">            border: 1px solid #ddd;</span>
<span class="s2">            background-color: #f9f9f9;</span>
<span class="s2">            border-radius: 5px;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        .wikitable </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">            width: 100%;</span>
<span class="s2">            border-collapse: collapse;</span>
<span class="s2">            margin: 20px 0;</span>
<span class="s2">            font-size: 14px;</span>
<span class="s2">            text-align: left;</span>
<span class="s2">            page-break-inside: avoid;</span>
<span class="s2">        </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">        .wikitable th, .wikitable td [[:Template:Border: 1px solid]]</span>
<span class="s2">        .wikitable tr [[:Template:Page-break-inside: avoid;]]</span>
<span class="s2">        .wikitable tr:nth-child(even) [[:Template:Background-color:]]</span>
<span class="s2">        .wikitable tr:hover [[:Template:Background-color:]]</span>
<span class="s2">        .wikitable th [[:Template:Background-color:]]</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">        &lt;/head&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">        </span><span class="si">{</span><span class="n">main_content</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        """</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">styled_content</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Created </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_file</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error creating PDF for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">generate_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">'pdfs/Table_of_Contents.pdf'</span><span class="p">):</span>
        <span class="sd">"""Generate a Table of Contents PDF with indented subchapters."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Generating Table of Contents..."</span><span class="p">)</span>
        <span class="n">toc_html</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">        &lt;head&gt;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">        body {{</span>
<span class="s2">            margin: 20px;</span>
<span class="s2">            font-family: Arial, sans-serif;</span>
<span class="s2">        }}</span>
<span class="s2">        h1 {{</span>
<span class="s2">            text-align: center;</span>
<span class="s2">            font-size: 28px;</span>
<span class="s2">        }}</span>
<span class="s2">        ul {{</span>
<span class="s2">            list-style: none;</span>
<span class="s2">            padding: 0;</span>
<span class="s2">        }}</span>
<span class="s2">        li [[:Template:Margin: 5px 0;]]</span>
<span class="s2">        .chapter {{</span>
<span class="s2">            font-weight: bold;</span>
<span class="s2">            font-size: 16px;</span>
<span class="s2">        }}</span>
<span class="s2">        .subchapter {{</span>
<span class="s2">            font-size: 14px;</span>
<span class="s2">            margin-left: 20px;</span>
<span class="s2">        }}</span>
<span class="s2">        a {{</span>
<span class="s2">            color: blue;</span>
<span class="s2">            text-decoration: none;</span>
<span class="s2">        }}</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">        &lt;/head&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Table of Contents&lt;/h1&gt;</span>
<span class="s2">        &lt;ul&gt;</span>
<span class="s2">        """</span>
        <span class="k">for</span> <span class="n">chapter_number</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_entries</span><span class="p">:</span>
            <span class="n">toc_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">'&lt;li class="chapter"&gt;</span><span class="si">{</span><span class="n">chapter_number</span><span class="si">}</span><span class="s1">. &lt;a href="#</span><span class="si">{</span><span class="n">chapter_id</span><span class="si">}</span><span class="s1">"&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&lt;/a&gt;&lt;/li&gt;'</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subchapters</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">toc_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">'&lt;li class="subchapter"&gt;</span><span class="si">{</span><span class="n">chapter_number</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> &lt;a href="#</span><span class="si">{</span><span class="n">chapter_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">"&gt;</span><span class="si">{</span><span class="n">sub</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1">&lt;/a&gt;&lt;/li&gt;'</span>

        <span class="n">toc_html</span> <span class="o">+=</span> <span class="s2">"&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;"</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">toc_html</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Created </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error creating Table of Contents PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">merge_pdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf_files</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Merging PDFs into </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">merger</span> <span class="o">=</span> <span class="n">PdfMerger</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdf_files</span><span class="p">:</span>
            <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully created </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_epub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">'FreeCAD_User_Manual.epub'</span><span class="p">):</span>
        <span class="sd">"""Create an EPUB version of the manual."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Creating EPUB: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Initialize EPUB book</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">epub</span><span class="o">.</span><span class="n">EpubBook</span><span class="p">()</span>

        <span class="c1"># Set metadata</span>
        <span class="n">book</span><span class="o">.</span><span class="n">set_identifier</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="n">book</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'FreeCAD User Manual'</span><span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">set_language</span><span class="p">(</span><span class="s1">'en'</span><span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add_author</span><span class="p">(</span><span class="s1">'FreeCAD Community'</span><span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">set_cover</span><span class="p">(</span><span class="s2">"cover.jpg"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cover</span><span class="p">())</span>

        <span class="c1"># Add CSS</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">            body { margin: 20px; font-family: Arial, sans-serif; }</span>
<span class="s1">            h1 { text-align: center; font-size: 2em; margin-bottom: 1em; }</span>
<span class="s1">            h2 { font-size: 1.5em; margin-top: 1em; }</span>
<span class="s1">            img { max-width: 100%; height: auto; }</span>
<span class="s1">            code, pre {</span>
<span class="s1">                font-family: monospace;</span>
<span class="s1">                background-color: #f4f4f4;</span>
<span class="s1">                padding: 0.5em;</span>
<span class="s1">                display: block;</span>
<span class="s1">                white-space: pre-wrap;</span>
<span class="s1">                border: 1px solid #ddd;</span>
<span class="s1">                border-radius: 5px;</span>
<span class="s1">            }</span>
<span class="s1">            table {</span>
<span class="s1">                width: 100%;</span>
<span class="s1">                border-collapse: collapse;</span>
<span class="s1">                margin: 1em 0;</span>
<span class="s1">            }</span>
<span class="s1">            th, td {</span>
<span class="s1">                border: 1px solid #ddd;</span>
<span class="s1">                padding: 0.5em;</span>
<span class="s1">            }</span>
<span class="s1">        '''</span>
        <span class="n">nav_css</span> <span class="o">=</span> <span class="n">epub</span><span class="o">.</span><span class="n">EpubItem</span><span class="p">(</span>
            <span class="n">uid</span><span class="o">=</span><span class="s2">"style_nav"</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">"style/nav.css"</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">style</span>
        <span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">nav_css</span><span class="p">)</span>

        <span class="c1"># Create chapters</span>
        <span class="n">chapters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chapter_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chapters_html</span><span class="p">:</span>
            <span class="c1"># Create chapter</span>
            <span class="n">chapter</span> <span class="o">=</span> <span class="n">epub</span><span class="o">.</span><span class="n">EpubHtml</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">chapter_data</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span>
                <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'chapter_</span><span class="si">{</span><span class="n">chapter_data</span><span class="p">[</span><span class="s2">"number"</span><span class="p">]</span><span class="si">}</span><span class="s1">.xhtml'</span><span class="p">,</span>
                <span class="n">lang</span><span class="o">=</span><span class="s1">'en'</span>
            <span class="p">)</span>

            <span class="c1"># Process content for EPUB</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">chapter_data</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span>

            <span class="c1"># Handle images</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'img'</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">'epub_data'</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="s1">'epub_src'</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># Generate a content hash for the image data</span>
                    <span class="kn">import</span> <span class="nn">hashlib</span>
                    <span class="n">img_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="s1">'epub_data'</span><span class="p">])</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

                    <span class="c1"># Check if we've seen this image before</span>
                    <span class="k">if</span> <span class="n">img_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_cache</span><span class="p">:</span>
                        <span class="c1"># This is a new image</span>
                        <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">img_hash</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">img</span><span class="p">[</span><span class="s2">"epub_src"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">img_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_filename</span>

                        <span class="c1"># Add image to EPUB</span>
                        <span class="n">image_item</span> <span class="o">=</span> <span class="n">epub</span><span class="o">.</span><span class="n">EpubItem</span><span class="p">(</span>
                            <span class="n">uid</span><span class="o">=</span><span class="sa">f</span><span class="s1">'image_</span><span class="si">{</span><span class="n">img_hash</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
                            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'images/</span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
                            <span class="n">media_type</span><span class="o">=</span><span class="s1">'image/png'</span><span class="p">,</span>
                            <span class="n">content</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="s1">'epub_data'</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">image_item</span><span class="p">)</span>

                    <span class="c1"># Update image source to use cached filename</span>
                    <span class="n">img</span><span class="p">[</span><span class="s1">'src'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'images/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">img_hash</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
                    <span class="c1"># Remove EPUB-specific attributes</span>
                    <span class="k">del</span> <span class="n">img</span><span class="p">[</span><span class="s1">'epub_data'</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">img</span><span class="p">[</span><span class="s1">'epub_src'</span><span class="p">]</span>

            <span class="c1"># Set chapter content</span>
            <span class="n">chapter</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">chapter</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">nav_css</span><span class="p">)</span>

            <span class="c1"># Add chapter</span>
            <span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">chapter</span><span class="p">)</span>
            <span class="n">chapters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chapter</span><span class="p">)</span>

        <span class="c1"># Create table of contents</span>
        <span class="n">book</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="p">[(</span><span class="n">epub</span><span class="o">.</span><span class="n">Section</span><span class="p">(</span><span class="s1">'Table of Contents'</span><span class="p">),</span> <span class="n">chapters</span><span class="p">)]</span>

        <span class="c1"># Add navigation files</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">epub</span><span class="o">.</span><span class="n">EpubNcx</span><span class="p">())</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">epub</span><span class="o">.</span><span class="n">EpubNav</span><span class="p">())</span>

        <span class="c1"># Define reading order</span>
        <span class="n">book</span><span class="o">.</span><span class="n">spine</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'nav'</span><span class="p">]</span> <span class="o">+</span> <span class="n">chapters</span>

        <span class="c1"># Write EPUB file</span>
        <span class="n">epub</span><span class="o">.</span><span class="n">write_epub</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully created </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Generate a simple cover image for the EPUB."""</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>

        <span class="c1"># Create a new image with a white background</span>
        <span class="n">cover</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">,</span> <span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">2400</span><span class="p">),</span> <span class="s1">'white'</span><span class="p">)</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">cover</span><span class="p">)</span>

        <span class="c1"># Add title text</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">"Arial"</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">load_default</span><span class="p">()</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s2">"FreeCAD</span><span class="se">\n</span><span class="s2">User Manual"</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">title</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">"mm"</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>

        <span class="c1"># Add date</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1300</span><span class="p">),</span> <span class="n">date_str</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">"mm"</span><span class="p">)</span>

        <span class="c1"># Convert to bytes</span>
        <span class="n">img_byte_arr</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">cover</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_byte_arr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'JPEG'</span><span class="p">)</span>
        <span class="n">img_byte_arr</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">img_byte_arr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">batch_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">'pdfs'</span><span class="p">,</span> <span class="n">merged_pdf</span><span class="o">=</span><span class="s1">'FreeCAD_User_Manual.pdf'</span><span class="p">,</span> <span class="n">create_epub</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Convert manual to both PDF and EPUB formats."""</span>
        <span class="c1"># First create PDF as before</span>
        <span class="n">pdf_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chapter_number</span><span class="p">,</span> <span class="p">(</span><span class="n">chapter_url</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">chapter_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[&lt;&gt;:"/</span><span class="se">\\</span><span class="s1">?*]'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">,</span> <span class="n">chapter_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pdf_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_pdf</span><span class="p">(</span><span class="n">chapter_url</span><span class="p">,</span> <span class="n">chapter_number</span><span class="p">,</span> <span class="n">chapter_id</span><span class="p">,</span> <span class="n">subchapters</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pdf_file</span><span class="p">:</span>
                <span class="n">pdf_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span>

        <span class="c1"># Generate and merge Table of Contents</span>
        <span class="n">toc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"Table_of_Contents.pdf"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_toc</span><span class="p">(</span><span class="n">toc_file</span><span class="p">)</span>
        <span class="n">pdf_files</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">toc_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_pdfs</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">,</span> <span class="n">merged_pdf</span><span class="p">)</span>

        <span class="c1"># Create EPUB version if requested</span>
        <span class="k">if</span> <span class="n">create_epub</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_epub</span><span class="p">(</span><span class="s1">'FreeCAD_User_Manual.epub'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">converter</span> <span class="o">=</span> <span class="n">FreeCADManualConverter</span><span class="p">()</span>
    <span class="n">manual_links</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">extract_manual_links</span><span class="p">()</span>
    <span class="n">converter</span><span class="o">.</span><span class="n">batch_convert</span><span class="p">(</span><span class="n">manual_links</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">'pdfs'</span><span class="p">,</span>
                          <span class="n">merged_pdf</span><span class="o">=</span><span class="s1">'FreeCAD_User_Manual.pdf'</span><span class="p">,</span>
                          <span class="n">create_epub</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<!-- 
NewPP limit report
Cached time: 20250624191310
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc, no&#8208;toc&#8208;conversion]
CPU time usage: 0.286 seconds
Real time usage: 1.014 seconds
Preprocessor visited node count: 175/1000000
Post&#8208;expand include size: 2649/2097152 bytes
Template argument size: 17877/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 6/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 72152/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%  670.132      1 -total
 98.20%  658.052      2 Template:MacroCode
  1.19%    7.959      1 Template:Macro
  0.53%    3.543      2 Template:Code
  0.15%    0.994      1 Template:Page-break-inside:_avoid;
  0.14%    0.926      1 Template:Border:_1px_solid
  0.13%    0.891      3 Template:Background-color:
  0.13%    0.849      1 Template:Margin:_5px_0;
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:366536-0!canonical and timestamp 20250624191309 and revision id 1595957. Rendering was triggered because: edit-page
 -->
</div>
</div><script src="site.js"></script>