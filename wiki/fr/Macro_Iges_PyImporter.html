<link href="../site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Macro Iges PyImporter/fr</span></h1><?xml encoding="UTF-8"><div class="mw-parser-output"><div class="mw-pt-languages noprint" lang="en" dir="ltr"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a href="../Macro_Iges_PyImporter.html" class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" title="Macro Iges PyImporter (100% translated)" lang="en" dir="ltr">English</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" lang="fr" dir="ltr">fran&ccedil;ais</span></li>
<li><a href="../pl/Macro_Iges_PyImporter.html" class="mw-pt-progress mw-pt-progress--stub" title="Makrodefinicja: PyImporter z formatu Iges (6% translated)" lang="pl" dir="ltr">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="../File/Text-x-python.png" class="mw-file-description" title="Generic macro icon"><img alt="Generic macro icon" src="../File/Text-x-python.png" decoding="async" width="32" height="32"></a></span><span> </span>
Iges_PyImporter
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Importer un fichier IGES avec l'entit&eacute; 128 dans FreeCAD.<br><br>Version macro&nbsp;: 0.2<br>Date derni&egrave;re modification&nbsp;: 2022-03-26<br>Version FreeCAD&nbsp;: Toutes<br>Auteur: heda<br>
</td></tr>
<tr>
<th class="ctOdd">Auteur
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="../index.php?title=User;Heda&amp;action=edit&amp;redlink=1.html" class="new" title="User:Heda (page does not exist)">heda</a>
</td></tr>
<tr>
<th class="ctOdd">T&eacute;l&eacute;chargement
</th></tr>
<tr>
<td class="ctEven macro-download"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Liens
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../fr/Macros_recipes.html" title="Macros recipes/fr">Page des macros</a><br><a href="../fr/How_to_install_macros.html" title="How to install macros/fr">Comment installer une macro</a><br><a href="../fr/Customize_Toolbars.html" title="Customize Toolbars/fr">Comment cr&eacute;er une barre d'outils</a>
</td></tr>
<tr>
<th class="ctOdd">Version Macro
</th></tr>
<tr>
<td class="ctEven macro-version">0.2
</td></tr>
<tr>
<th class="ctOdd">Derni&egrave;re modification
</th></tr>
<tr>
<td class="ctEven macro-date">2022-03-26
</td></tr>
<tr>
<th class="ctOdd">Version(s) FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">Toutes
</td></tr>
<tr>
<th class="ctOdd">Raccourci clavier
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Voir aussi
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><meta property="mw:PageProp/toc">
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>Importation automatique de fichiers iges ascii avec des surfaces de B-spline, entit&eacute; 128, par exemple cr&eacute;&eacute;s avec FreeShip, qui semble toujours &ecirc;tre mal g&eacute;r&eacute; par <a href="../fr/OpenCASCADE.html" title="OpenCASCADE/fr">OCC</a>.
</p><p>De plus amples informations sont disponibles dans la <code>docstring</code> de la macro.
</p><p>La macro peut &ecirc;tre &eacute;tendue pour couvrir d'autres entit&eacute;s. Chacun est libre de d&eacute;velopper, de modifier et d'am&eacute;liorer la macro, le mieux &eacute;tant de la modifier ici sur le Wiki.
</p><p><span id="Usage"></span>
</p>
<h2><span class="mw-headline" id="Utilisation">Utilisation</span></h2>
<p>Lancez la macro et s&eacute;lectionnez un fichier IGES.
</p><p>Options&nbsp;:
</p>
<ul><li>cr&eacute;er une coque</li>
<li>appliquer la couleur</li>
<li>barre de progression</li></ul>
<p><span id="Install"></span>
</p>
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>Avec le gestionnaire des extensions.
</p><p><span id="Link"></span>
</p>
<h2><span class="mw-headline" id="Liens">Liens</span></h2>
<p>Forum&nbsp;: il n'y a pas de fil de discussion d&eacute;di&eacute;, mais cette macro a &eacute;t&eacute; cr&eacute;&eacute;e &agrave; partir de ce <a rel="nofollow" class="external text" href="https://forum.freecad.org/viewtopic.php?p=582137&amp;sid=3a86de4d61ef810a81861c757e15129c#p582137">fil du forum</a>.
</p>
<h2><span class="mw-headline" id="Version">Version</span></h2>
<p>v0.2 2022-03-26&nbsp;: premi&egrave;re version
</p>
<h2><span class="mw-headline" id="Code">Code</span></h2>
<p><b>Macro_Iges_PyImporter.FCMacro</b>
</p>
<pre>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# ***************************************************************************
# *   Copyright (c) 2022 heda &lt;heda @ freecad forum&gt;                        *
# *                                                                         *
# *   This file is part of the FreeCAD CAx development system.              *
# *                                                                         *
# *   This program is free software; you can redistribute it and/or modify  *
# *   it under the terms of the GNU Lesser General Public License (LGPL)    *
# *   as published by the Free Software Foundation; either version 2 of     *
# *   the License, or (at your option) any later version.                   *
# *   for detail see the LICENSE text file.                                 *
# *                                                                         *
# *   This program is distributed in the hope that it will be useful,       *
# *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
# *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
# *   GNU Library General Public License for more details.                  *
# *                                                                         *
# *   You should have received a copy of the GNU Library General Public     *
# *   License along with this program; if not, write to the Free Software   *
# *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  *
# *   USA                                                                   *
# *                                                                         *
# ***************************************************************************


__Name__ = 'Iges_PyImporter'
__Comment__ = 'Imports an iges file with entity 128 to FreeCAD'
__Author__ = 'heda @ fc-forum'
__Version__ = '0.2'
__Date__ = '2022-03-26'
__License__ = 'LGPL-2.0-or-later'
__Web__ = ''
__Wiki__ = 'https://wiki.freecad.org/Macro_Iges_PyImporter'
__Icon__ = ''
__Help__ = 'Launch macro and select file.'
__Status__ = 'works'
__Requires__ = 'tested on FreeCAD v0.19'
__Communication__ = 'forum'
__Files__ = ''



__doc__ = """
Standalone import for ascii iges-files with bspline surfaces,
entity 128, which appears to always be incorrectly handled by occ.

options:
- make shell [default on] or individual surfaces
  if off, the making of shell is enforced for files with more than 50 surfaces
- apply color [default on] if color is present in the iges-file,
  the parser naivly takes the first and ignores any following color records
- progress bar [default on] see note.

Run macro and select the iges file.
Creation of the surfaces can take a while.
Import is to current document if available, else a new is created.

There are no error or consistency checks, the parser either works or fails.
The only parsed entity is 128 - rational bspline surface,
assumed to be freeform. Parsing ability could be expanded,
specification used is iges5.3.

The importer is tested on:
- one freeship file
- one libIGES file

v0.1 - first version - handled iges files created by freeship.
v0.2 - also handles files made with libIGES (on gh).

note: if the macro has an error, the use of the progress bar makes fc
      freezes in monumental ways, the application has to be killed
      with system commands. If so, switch off the progress bar.
"""


import FreeCAD as App
import FreeCADGui as Gui
import Part
from PySide import QtGui

import re
from pathlib import Path
from collections import namedtuple, Counter

### options
MakeShell = True
ShellLimit = 50
ApplyColor = True
ProgressBar = True

filename, filt = QtGui.QFileDialog.getOpenFileName(filter='*.igs')

if not filename:
    raise UserWarning('Need to select an iges file.')

print('Importing: {}'.format(filename))

class Ticker:
    """better than nothing, does not always show though"""
    tick_count = 0
    pbon = ProgressBar
    if pbon:
        pb = App.Base.ProgressIndicator() 
        pb.start('importing iges', 100)
    
    def tick(self, ticks=1):
        if self.pbon:
            for i in range(ticks):
                self.pb.next()
                self.tick_count += 1

    def tick_time(self, prog):
        if isinstance(self.tick_step, int):
            self.tick(self.tick_step)
        else:
            if prog in self.tick_step:
                self.tick()
    
    def set_tick_step(self, number):
        self.tot_number = number
        span = 100 - 3 * 4
        if number &gt;= span:
            self.tick_step = tuple(range(0, number, int(number / span) + 1))
        else:
            self.tick_step = int(span / number)
        
    def end(self):
        if self.pbon:
            for i in range(101 - self.tick_count):
                self.tick()
            self.pb.stop()


ticker = Ticker()


iges = Path(filename)
data = iges.read_text().splitlines()

sec_def = re.compile('\W+')
sections = dict(S='', G='', D=list(), P=dict())
DES = namedtuple('DES', 'entity linecount label')
oddeven = color = None

for i, line in enumerate(data):
    sec_col = line[72:]
    section, snbr = sec_def.split(sec_col)
    if section in 'SG':
        sections[section] += line[:72]
    elif section == 'D':
        if oddeven is None:
            oddeven = bool(i&nbsp;% 2)
        if isinstance(oddeven, bool):
            if bool(i&nbsp;% 2) == oddeven:
                row1 = [line[j:j+8] for j in range(0, 80, 8)]
                row2 = [data[i+1][j:j+8] for j in range(0, 80, 8)]
                entitydef = (int(row1[0]), int(row2[3]), row2[-3])
                sections['D'].append(DES(*entitydef))
    elif section == 'P':
        break

lc = i

### header
fields = ' '.join(('f{}'.format(i+1) for i in range(25)))
for oldnew in (('f6 preprocessor', 'f14 unitsflag', 'f23 version')):
    fields = fields.replace(*oldnew.split())
Header = namedtuple('Header', fields)
cheat = sections.get('G').split(',')
cheat[0] += ',' # assume that the parameter delimiter is a comma
if len(cheat) == 26:
    cheat.pop(1) # the freeship file

header = Header(*cheat)

### unit
Units = dict(u1=(25.4, 'inch'),
             u2=(1, 'mm'),
             u3=(1, 'user defined, skip'),
             u4=(25.4 * 12, 'feet'),
             u5=(1, 'miles, skipping'),
             u6=(1000, 'meters'),
             u7=(10000, 'kilometers'),
             u8=(25.4 / 1000, 'milli inch'),
             u9=(1, 'micron, skipping'),
             u10=(10, 'centimeters'),
             u11=(1, 'micro inches, skipping'),
             )

unit, unitname = Units.get('u{}'.format(header.unitsflag))
msg = 'file units: {} / preprocessor: {}'
print(msg.format(unitname, header.preprocessor))

ticker.tick(3)

### color
# naive assumtion that color is first entry
msg = 'color definition found in file'
if 314 in set((desi.entity for desi in sections['D'])):
    des = sections['D'].pop(0)
    code, *rgb, _ = data[lc].split(';')[0].split(',')
    color = tuple(float(c) / 100 for c in (rgb)) + (0.,)
    lc += des.linecount
    print(msg)
else:
    print('no ' + msg)

ticker.tick(3)

entities, skipped = list(), list()
for des in sections['D']:
    if des.entity == 128:
        chunk = ''
        for line in data[lc:lc+des.linecount]:
            chunk += line[:64].strip()
        entities.append(chunk.strip()[:-1])
    else:
        skipped.append(des.entity)
    lc += des.linecount

print('found {} surfaces'.format(len(entities)))
if skipped:
    for entity, count in Counter(skipped).items():
        print('skipped {} records of entity {}'.format(count, entity))
else:
    print('no records skipped during parsing')
print('creating surfaces...')

Gui.updateGui() # flushes prints
ticker.tick(3)
ticker.set_tick_step(len(entities))

MakeShell = MakeShell if len(entities) &lt; ShellLimit + 1 else True
doc = App.ActiveDocument if App.ActiveDocument else App.newDocument(iges.stem)

surfs = list()

### parse iges record and create fc surface
for j, entity in enumerate(entities):
    entity = entity.split(',')
    entity[:10] = [int(i) for i in entity[:10]]
    entity[10:] = [float(i) for i in entity[10:]]
    K1, K2, M1, M2, P1, P2, P3, P4, P5 = entity[1:10]
    N1 = 1 + K1 - M1
    N2 = 1 + K2 - M2
    A = N1 + 2 * M1
    B = N2 + 2 * M2
    C = (1 + K1) * (1 + K2)
    # matrix is K1 + 1 x K2 + 1; u,v
    
    uknots = entity[10:10+A+1]
    vknots = entity[11+A:11+A+B+1]
    weights = entity[12+A+B:11+A+B+C+1]
    poles = entity[12+A+B+C:11+A+B+4*C+1]
    
    if P3 == 0: # rational
        u0, u1, v0, v1 = entity[12+A+B+4*C:15+A+B+4*C+1]
    else: # polynomial
        pass
    
    umults = [uknots.count(kn) for kn in sorted(set(uknots))]
    vmults = [vknots.count(kn) for kn in sorted(set(vknots))]
    
    if P3 == 0:
        pass
    else:
        uknots = uknots[M1:-M1]
        vknots = vknots[M2:-M2]
    
    poles = [App.Vector(*pt) * unit
             for pt in zip(poles[0::3], poles[1::3],poles[2::3])]
    
    poles = [poles[i:i+K1+1] for i in range(0, len(poles), K1+1)]
    weights = [weights[i:i+K1+1] for i in range(0, len(weights), K1+1)]
    poles = list(zip(*poles))
    weights = list(zip(*weights))
    
    bsurface = Part.BSplineSurface()
    builder = bsurface.buildFromPolesMultsKnots
    builder(poles, umults, vmults, uknots, vknots,
            bool(P4), bool(P5), M1, M2, weights)
    
    if MakeShell:
        surfs.append(bsurface.toShape())
    else:
       Part.show(bsurface.toShape(), 'Surface')
       if color and ApplyColor:
           doc.ActiveObject.ViewObject.ShapeColor = color

    ticker.tick_time(j)
    

if MakeShell:
    shell = Part.makeShell(surfs)
    Part.show(shell, iges.stem)
    if color and ApplyColor:
        doc.ActiveObject.ViewObject.ShapeColor = color
    doc.ActiveObject.ViewObject.DisplayMode = 'Shaded'

ticker.tick(3)

doc.recompute()
av = Gui.ActiveDocument.ActiveView
av.viewIsometric()
av.fitAll()
print('... import iges completed')
ticker.end()

# end</pre>
<!-- 
NewPP limit report
Cached time: 20250616182221
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc, no&#8208;toc&#8208;conversion]
CPU time usage: 0.066 seconds
Real time usage: 0.087 seconds
Preprocessor visited node count: 103/1000000
Post&#8208;expand include size: 1930/2097152 bytes
Template argument size: 10153/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 2/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 10649/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%   10.294      1 -total
 57.55%    5.924      1 Template:Macro/fr
 20.82%    2.143      1 Template:MacroCode
 18.65%    1.920      1 Template:Incode
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:282262-0!canonical and timestamp 20250616182221 and revision id 1474555. Rendering was triggered because: api-parse
 -->
</div>
</div><script src="../site.js"></script>