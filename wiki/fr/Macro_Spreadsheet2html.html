<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro Spreadsheet2html/fr</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="Macro_Spreadsheet2html.html" lang="en" title="Macro Spreadsheet2html (100% translated)">English</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" dir="ltr" lang="fr">français</span></li>
<li><a class="mw-pt-progress mw-pt-progress--stub" dir="ltr" href="Macro_Spreadsheet2html.html" lang="pl" title="Makrodefinicja: Arkusz kalkulacyjny do html (8% translated)">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/Text-x-python.png" title="Generic macro icon"><img alt="Generic macro icon" decoding="async" height="32" src="../File/Text-x-python.png" srcset="/images/2/2c/Text-x-python.png 1.5x" width="32"/></a></span><span> </span>
Spreadsheet2html
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Exporte une feuille de calcul fc au format html.<br/><br/>Version macro : 0.1<br/>Date dernière modification : 2021-08-09<br/>Version FreeCAD : tout avec feuille de calcul<br/>Auteur: heda<br/>
</td></tr>
<tr>
<th class="ctOdd">Auteur
</th></tr>
<tr>
<td class="ctEven macro-author"><a class="new" href="index.php?title=User;Heda&amp;action=edit&amp;redlink=1.html" title="User:Heda (page does not exist)">heda</a>
</td></tr>
<tr>
<th class="ctOdd">Téléchargement
</th></tr>
<tr>
<td class="ctEven macro-download"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Liens
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes/fr">Page des macros</a><br/><a href="How_to_install_macros.html" title="How to install macros/fr">Comment installer une macro</a><br/><a href="Customize_Toolbars.html" title="Customize Toolbars/fr">Comment créer une barre d'outils</a>
</td></tr>
<tr>
<th class="ctOdd">Version Macro
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Dernière modification
</th></tr>
<tr>
<td class="ctEven macro-date">2021-08-09
</td></tr>
<tr>
<th class="ctOdd">Version(s) FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">tout avec feuille de calcul
</td></tr>
<tr>
<th class="ctOdd">Raccourci clavier
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Voir aussi
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Description"><span class="tocnumber">1</span> <span class="toctext">Description</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Utilisation"><span class="tocnumber">2</span> <span class="toctext">Utilisation</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Installation"><span class="tocnumber">3</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Liens"><span class="tocnumber">4</span> <span class="toctext">Liens</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Version"><span class="tocnumber">5</span> <span class="toctext">Version</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Code"><span class="tocnumber">6</span> <span class="toctext">Code</span></a></li>
</ul>
</div>
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>Exporte le contenu d'une feuille de calcul FreeCAD en tant que html stylé, peut être utilisé pour l'importer dans LibreOffice Writer ou Calc. Plus d'informations dans la docstring de la macro.
</p>
<h2><span class="mw-headline" id="Utilisation">Utilisation</span></h2>
<p>Sélectionnez une feuille de calcul et exécutez la macro.
</p>
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>Avec le gestionnaire des extensions.
</p>
<h2><span class="mw-headline" id="Liens">Liens</span></h2>
<p>Forum : pas de fil au moment de la rédaction.
</p>
<h2><span class="mw-headline" id="Version">Version</span></h2>
<p>v0.1 2021-08-09 : première version
</p>
<h2><span class="mw-headline" id="Code">Code</span></h2>
<p><b>Macro_Spreadsheet2html.FCMacro</b>
</p>
<pre>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# ***************************************************************************
# *   Copyright (c) 2021 heda &lt;@fc-forum&gt;                                   *
# *                                                                         *
# *   This file is part of the FreeCAD CAx development system.              *
# *                                                                         *
# *   This program is free software; you can redistribute it and/or modify  *
# *   it under the terms of the GNU Lesser General Public License (LGPL)    *
# *   as published by the Free Software Foundation; either version 2 of     *
# *   the License, or (at your option) any later version.                   *
# *   for detail see the LICENCE text file.                                 *
# *                                                                         *
# *   This program is distributed in the hope that it will be useful,       *
# *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
# *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
# *   GNU Library General Public License for more details.                  *
# *                                                                         *
# *   You should have received a copy of the GNU Library General Public     *
# *   License along with this program; if not, write to the Free Software   *
# *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  *
# *   USA                                                                   *
# *                                                                         *
# ***************************************************************************


__Name__ = 'Spreadsheet2html'
__Comment__ = 'Exports a fc spreadsheet as html. NOTE: wiki caps code so follow instruction on wiki for install.'
__Author__ = 'heda @ fc-forum'
__Version__ = '0.1'
__Date__ = '2021-08-09'
__License__ = 'LGPL-2.0-or-later'
__Web__ = ''
__Wiki__ = 'Associated wiki page'
__Icon__ = ''
__Help__ = 'Select a spreadsheet and launch macro.'
__Status__ = 'Stable'
__Requires__ = 'tested on FreeCAD v0.19'
__Communication__ = 'forum'
__Files__ = ''



__doc__ = """
Exports a selected spreadsheet as html, can be opened directly in LO-Writer.
File is saved in user Documents with similar name as the fc-file.
All cells with content are included in the exported range.

To use with LO-Writer:
  - open the html-file directly with LO-Writer

To use with LO-Calc:
  - create new LO-Calc doc
  - menu: "Sheet/Link to External Data" and select the generated html file

There are 5 options for the generated html:
  - values without any formatting or comments
  - values with formatting &amp; comments (default)
  - formulas with formatting &amp; comments
  - extra table for comments, i.e. units, formulas &amp; alias (default without)
  - with/without table borders (default with)
  
The options are set in the macrofile, not via gui.

Imports to Calc does not respect column width &amp; row heigth,
html in browser and Writer does...
Same goes for merged cells.
Neither Writer nor Calc parses the comments, hence the option for extra table.

Alias:
  The extra table helps in recreating alias in Calc, to redefine the
  name within Calc (look in LO-Calc docs if you want to know how).

  Obviously the use of alias is only working for an alias that
  has references that Calc understands, so "=A1+B2" works,
  while "=Box.Length" does not.
  
  For the cases where the evaluation should work, one still has to
  select the cell with the formula and click the "equal sign" in
  the formula bar of Calc user interface.

Comments contains the following as per availability:
  - unit strings when defined on cells in fc
  - name of alias when defined on cells in fc
  - formulas if the option to evaluate expressions to values is True (default)
  - evaluated value if the option to keep formulas is True

For the option "paste values" it is just the evaluated values of the cells.
The option does not pass along comments.
"""

filelocation = 'Documents'
options = dict(PasteSpecial_values=False,
               PasteSpecial_values_and_format=True,
               PasteSpecial_formulas_and_format=False,
               CommentTable=False,
               TableBorder=True)

ColumnWidthFactor = 100/85 # FC has 100 as std width, 85 is reasonable for LO
RowHeightFactor = 30/17

import FreeCADGui as Gui

import re
import html as htmllib
import xml.etree.ElementTree as ET
from string import ascii_uppercase
from itertools import product
from pathlib import Path
from datetime import datetime as dt


#spreadsheet = App.ActiveDocument.Spreadsheet

spreadsheet, = Gui.Selection.getSelection()
sp_name = spreadsheet.FullName.replace('#', '-')
sp_content = spreadsheet.cells.Content
root = ET.fromstring(sp_content)

cells = dict()
for el in root:
    if not 'Cell' in el.tag: continue
    address = el.attrib.pop('address')
    cells[address] = el.attrib

#import pprint
#pp = pprint.PrettyPrinter(indent=4)
#pp.pprint(cells)

### find range of sheet
##  (would be nice with a simple sp.getRange())
char = re.compile(r'\d+')
num = re.compile(r'\D+')

def split_address(address):
    C, _, _, R = char.split(address) + num.split(address)
    return C, int(R)

tmp = dict(split_address(address) for address in cells)
Rmax = max(tmp.values())
## need to separate one and two chars comparison
if any(map(lambda s: len(s) == 2, tmp)):
    Cmax = max(filter(lambda s: len(s) == 2, tmp))
else:
    Cmax = max(tmp)

### prepare column and row iterable for actual range
column_iter = list(ascii_uppercase)
column_extension = 10 # assume that col-span on last col is limited to 9...
cart = product(ascii_uppercase, repeat=2)
if Cmax in column_iter:
    cut_idx = column_iter.index(Cmax) + 1
    length = range(column_extension)
    column_iter += [''.join(c) for _, c in zip(length, cart)]

    column_extension = column_iter[cut_idx:cut_idx + column_extension]
    column_iter = column_iter[:cut_idx]
else:
    a, b = (ord(c)-65 for c in Cmax)
    length = range(a * len(ascii_uppercase) + b + 1 + column_extension)
    column_iter += [''.join(c) for _, c in zip(length, cart)]
                
    column_extension = column_iter[-column_extension:]
    column_iter = column_iter[:-len(column_extension)]

## extend range where needed
hitcells = (cell for cell in cells if str(Rmax) in cell)
extend = max(cells.get(address).get('rowSpan', '1') for cell in hitcells)
Rmax += int(extend) - 1

extend = 1
for address in (cell for cell in cells if str(Cmax) in cell):
    v = int(cells.get(address).get('colSpan', 1))
    extend = v if v &gt; extend else extend
column_iter += column_extension[:int(extend) - 1]
column_iter = tuple(column_iter)
Cmax = column_iter[-1]


### generating html
# doctype workaround, tripping parser if there
doctype = '&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"/&gt;'

template = """
&lt;html&gt;
&lt;head&gt;
	
	&lt;meta http-equiv="content-type" content="text/html; charset=utf-8"/&gt;
	&lt;title&gt;FreeCAD&lt;/title&gt;
	&lt;meta name="template" content="LibreOffice (Calc) 6.4"/&gt;
	&lt;meta name="generator" content="FreeCAD macro - SpreadSheet2LibreOffice"/&gt;
	&lt;meta name="created" content=""/&gt;
	
	&lt;style type="text/css"&gt;
		a.comment-indicator:hover + comment { background:#ffd; position:absolute; display:block; border:1px solid black; padding:0.5em;  } 
		a.comment-indicator { background:red; display:inline-block; border:1px solid black; width:0.5em; height:0.5em;  } 
		comment { display:none;  } 
	&lt;/style&gt;
	
&lt;/head&gt;

&lt;body&gt;
&lt;table cellspacing="0" cellpadding="3" border="1"&gt;
&lt;/table&gt;
&lt;/body&gt;

&lt;/html&gt;
"""

doc = ET.fromstring(template)

title = doc.find('./head/title')
title.text += ' ' + sp_name
created = doc.find("./head/meta[@name='created']")
created.set('content', dt.now().strftime('%Y-%m-%d %H:%M:%S'))

table = doc.find('./body/table')
table.set('border', str(int(options.get('TableBorder'))))
    
for width in (spreadsheet.getColumnWidth(c) for c in column_iter):
    ET.SubElement(table, 'colgroup',
                  dict(width='{:.0f}'.format(width/ColumnWidthFactor)))

align_table = dict(left=('align', 'left'), center=('align', 'center'),
                   right=('align', 'right'),
                   top=('valign', 'top'), vcenter=('valign', 'middle'),
                   bottom=('valign', 'bottom'))
style_table = dict(bold='b', italic='i', underline='u')

skip_list = list()
for r in range(1, Rmax+1):
    rowheight = spreadsheet.getRowHeight(str(r)) / RowHeightFactor
    tr = ET.Element('tr', dict(height='{:.0f}'.format(rowheight)))
    for c in column_iter:
        address = f'{c}{r}'
        cell = cells.get(address, dict())
        new_attrib = dict()
        td = ET.Element('td')
        td.text = cell.get('content')
        # avoid overflow, implies look ahead
        colspan = int(cell.get('colSpan', 0))
        rowspan = int(cell.get('rowSpan', 0))
        if colspan &gt; 0:
            idx = column_iter.index(c) + 1
            gen = (f'{ci}{r}' for ci in column_iter[idx:idx + colspan - 1])
            skip_list.extend(gen)
            new_attrib.update(dict(colspan=str(colspan)))
        if rowspan &gt; 0:
            gen = (f'{c}{ri}' for ri in range(r + 1, r + rowspan))
            skip_list.extend(gen)
            new_attrib.update(dict(rowspan=str(rowspan)))
            
        if address in skip_list:
            continue
        
        tr.append(td)
        
        # styling and attributes
        subel, comment = list(), list()
        for k in sorted(cell):
            v = cell.get(k)
            if k == 'alias':
                comment.append('alias: {}'.format(v))
            elif k == 'alignment':
                for which in v.split('|'):
                    kva = align_table.get(which)
                    if kva:
                        new_attrib.update(dict((kva,)))
            elif k == 'backgroundColor':
                new_attrib.update(dict(bgcolor=v[:-2]))
            elif k == 'displayUnit':
                comment.append('unit: {}'.format(v))
            elif k == 'foregroundColor': # will always be first
                font = ET.Element('font', dict(color=v[:-2]))
                subel.append(font)
            elif k == 'style':
                for which in v.split(chr(124)):
                    sty = ET.Element(style_table.get(which))
                    subel.insert(0, sty)
        
        # formula options
        if isinstance(td.text, str) and td.text.startswith('='):
            if options.get('PasteSpecial_values'):
                td.text = str(spreadsheet.get(address)) # returns casted type
            elif options.get('PasteSpecial_values_and_format'):
                formula = td.text
                td.text = str(spreadsheet.get(address))
                comment.append('formula: {}'.format(formula))
            elif options.get('PasteSpecial_formulas_and_format'):
                value = spreadsheet.get(address)
                comment.append('value: {}'.format(value))

        if options.get('PasteSpecial_values'):
            subel, comment = list(), list()
            for k in tuple(new_attrib):
                if not 'span' in k:
                    _ = new_attrib.pop(k)

        # sanitize for html
        if td.text:
            td.text = htmllib.escape(td.text)

        if comment:
            ET.SubElement(td, 'a', {'class': 'comment-indicator'})
            popup = ET.Element('comment')
            popup.text = '  |  '.join((htmllib.escape(cm) for cm in comment))
            td.append(popup)
                        
        td.attrib = new_attrib

        if subel:
            parent = td
            for child in subel:
                child.text = parent.text
                parent.text = None
                parent.append(child)
                parent = child

    table.append(tr)

### extra table
if options.get('CommentTable'):

    template_extra = """
    &lt;table cellspacing="0" cellpadding="3" border="1"&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;b&gt;adress&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;b&gt;trace&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;b&gt;evaluated&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;b&gt;unit&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;b&gt;formula&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;b&gt;alias&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/table&gt;
    """
    table_extra = ET.fromstring(template_extra)
    
    table_extra.set('border', str(int(options.get('TableBorder'))))
    
    body = doc.find('./body')
    body.extend((ET.Element('p'), table_extra))
    
    for address, attrib in cells.items():
        row = [address, f'={address}', None,
               attrib.get('displayUnit'), None, attrib.get('alias')]

        content = attrib.get('content')
        if not content:
            continue

        row[2] = content
        if content.startswith('='):
            value = spreadsheet.get(address)
            row[2] = value
            row[4] = chr(39) + content
    
        tr = ET.Element('tr')
        for r in row:
            td = ET.Element('td')
            td.text = r
            tr.append(td)

        table_extra.append(tr)


### save file on disk
filehandle = Path.home() / filelocation / '{}.html'.format(sp_name)
htmldoc = ET.ElementTree(doc)
htmldoc.write(filehandle, encoding='utf-8',
              xml_declaration=True, method='html')

filehandle.write_text('\n'.join((doctype, filehandle.read_text())))

print('Exported spreadsheet as html.')

# end
</pre>
<!-- 
NewPP limit report
Cached time: 20241129211549
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.039 seconds
Real time usage: 0.052 seconds
Preprocessor visited node count: 88/1000000
Post‐expand include size: 1899/2097152 bytes
Template argument size: 232/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 2/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 14334/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    2.675      1 Template:Macro/fr
100.00%    2.675      1 -total
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:265435-0!canonical and timestamp 20241129211549 and revision id 1210528. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
