<link href="site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Macro server</span></h1><?xml encoding="UTF-8"><div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr"><table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="File/Macro_server.svg" class="mw-file-description"><img src="File/Macro_server.svg" decoding="async" width="32" height="32" class="mw-file-element" data-file-width="1935" data-file-height="1935"></a></span><span> </span>
server
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Allows external control over FreeCAD for automation purposes.<br><br>Macro version: 1.0<br>Last modified: 2026-01-23<br>FreeCAD version: 1.0<br>Download: <a href="images/d/d5/Macro_server.svg.html" class="internal" title="Macro server.svg">Media:Macro_server.svg</a><br>Author: Jjustra<br>
</td></tr>
<tr>
<th class="ctOdd">Author
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="index.php?title=User;Jjustra&amp;action=edit&amp;redlink=1.html" class="new" title="User:Jjustra (page does not exist)">Jjustra</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><a href="images/d/d5/Macro_server.svg.html" class="internal" title="Macro server.svg">Media:Macro_server.svg</a>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes">Macros recipes</a><br><a href="How_to_install_macros.html" title="How to install macros">How to install macros</a><br><a href="Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a>
</td></tr>
<tr>
<th class="ctOdd">Macro Version
</th></tr>
<tr>
<td class="ctEven macro-version">1.0
</td></tr>
<tr>
<th class="ctOdd">Date last modified
</th></tr>
<tr>
<td class="ctEven macro-date">2026-01-23
</td></tr>
<tr>
<th class="ctOdd">FreeCAD Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">1.0
</td></tr>
<tr>
<th class="ctOdd">Default shortcut
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">See also
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><meta property="mw:PageProp/toc">
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>Useful tool for FreeCAD automatization. The aim is for a small, versatile, 'top level'-only program.
</p><p>Remote FreeCAD management, no actual model editing (for such goal, see Extensions).
</p><p>You need client to send commands to this server. Included is simple python command line utility as reference implementation.
</p><p>This allows you to globally (but still in server's space not FreeCAD itself) select&nbsp;:
</p>
<ul><li>document</li>
<li>object</li>
<li>spreadsheet</li>
<li>path (mainly for export)</li></ul>
<p><br>
Subsequent operations may require document/object/spreadsheet/path
</p><p>(most of those arguments are optional)
</p>
<ul><li>given value is used first</li>
<li>then global one</li>
<li>and lastly active/default selection in FreeCAD itself</li></ul>
<p>e.g.:
</p>
<ul><li>&nbsp; you can get list of objects in active document with command 'O'</li>
<li>&nbsp; you can also get list of objects in concrete document with command 'Oconcrete_document'</li></ul>
<p>&nbsp; (list of all documents is returned by command 'D')
</p><p>It also allows you to get list of&nbsp;:
</p>
<ul><li>opened documents</li>
<li>objects with their Name and Label</li>
<li>cells in spreadsheet with their values</li></ul>
<p>And you can even&nbsp;:
</p>
<ul><li>get cell value</li>
<li>set cell value</li>
<li>recompute (needed after setting cells)</li>
<li>export</li></ul>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<h3><span class="mw-headline" id="Server">Server</span></h3>
<p>You start server by running macro. You can stop it the same way. Macro, therefore, acts as mere switch button and real magic happens elsewhere.
</p>
<h3><span class="mw-headline" id="Client">Client</span></h3>
<p>Included client script accepts command(s) in form of command line arguments. Each argument is one command.
</p><p>e.g.: ./freecad-ctl.py 'dMy_document_1' C '!B1 123' C
</p><p>This selects <b>My_document_1</b>, returns all cell's values in default spreadsheet, sets cell B1 to 123 and return all values again.
</p>
<h3><span class="mw-headline" id="Note">Note</span></h3>
<p>Don't forget to set ROOT path to server's stdin/stdout files - both in client AND in server before running it (variable ROOT at start of both files).
</p>
<h3><span class="mw-headline" id="Communication_protocol">Communication protocol</span></h3>
<p>Informations are exchanged thru two files. From server's POV one is input, the other output. From client's POV server's input is its output and vice versa.
</p><p>Every command returns some response.
</p>
<h4><span class="mw-headline" id="Command_format">Command format</span></h4>
<div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>&lt;one-letter-mod&gt;&lt;name&gt; &lt;data string&gt;
</pre></div><p>e.g.:</p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>!B1 123
</pre></div><p>where&nbsp;:
</p><ul><li><b>!</b>&nbsp;is mod/command</li>
<li><b>B1</b>&nbsp;is name</li>
<li><b>123</b> is string value (can be another name or just value; depends on situation)</li></ul>
<p>this sets cell B1 (in global or active document and spreadsheet) to value 123
</p>
<h4><span class="mw-headline" id="Commands">Commands</span></h4>
<p><i>I</i> - get server id
</p><p><i>D</i> - get list of open documents in form&nbsp;: d&lt;document&gt;
</p><p><i>O[&lt;document&gt;]</i> - get list of objects in form&nbsp;: o&lt;object&gt; &lt;label&gt;
</p><p><i>C[&lt;document&gt;] [&lt;spreadsheet&gt;]</i> - get list of cells in form&nbsp;: c&lt;cell-id&gt; &lt;value&gt;
</p><p><br>
<i>d&lt;document&gt;</i> - select document
</p><p><i>s[&lt;document&gt;] &lt;spreadsheet&gt;</i> - select spreadsheet
</p><p><i>o[&lt;document&gt;] &lt;object-name&gt;</i> - select object
</p><p><i>p &lt;file-path&gt;</i> - select/set path
</p><p><br>
<i>@&lt;cell-id&gt; [&lt;spreadsheet&gt;]</i> - get cell value in form&nbsp;: c&lt;cell-id&gt; &lt;value&gt;
</p><p><i>!&lt;cell-id&gt; &lt;value&gt;</i>&nbsp;- set cell value
</p><p><br>
<i>r[&lt;document&gt;]</i> - recompute document
</p><p><i>e[&lt;object&gt;] [&lt;file-path&gt;]</i> - export selected object
</p>
<h4><span class="mw-headline" id="Examples">Examples</span></h4><p>
Select document <b>My_document_0</b></p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>dMy_document_0
</pre></div><p>
Get list of objects from <b>My_document_1</b></p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>OMy_document_1
</pre></div><p>
Get list of objects from <b>My_document_0</b></p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>O
</pre></div><p>
Unselect document</p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>d
</pre></div><p>
Get list of objects from FreeCAD's active document</p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>O
</pre></div><p>
Get list of cells from default spreadsheet in <b>My_document_0</b></p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>CMy_document_0
</pre></div>
<p><br>
</p><p>
Get list of cells from <b>My_spreadsheet</b> in <b>My_document_0</b></p><div class="mw-highlight mw-highlight-lang-text mw-content-ltr" dir="ltr"><pre><span></span>CMy_document_0 My_spreadsheet
</pre></div>
<p><br>
</p><p>
Set path</p><div class="mw-highlight mw-highlight-lang-python3 mw-content-ltr" dir="ltr"><pre><span></span><span class="n">p</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">exported</span><span class="o">-</span><span class="n">part</span><span class="o">.</span><span class="n">stl</span>
</pre></div>
<p><br>
</p><p>
Export <b>Object_0</b> to selected path</p><div class="mw-highlight mw-highlight-lang-python3 mw-content-ltr" dir="ltr"><pre><span></span><span class="n">eObject_0</span>
</pre></div>
<h2><span class="mw-headline" id="Extensions">Extensions</span></h2>
<p>In case more functionality is required, beyond scope of this server, additions can be easily made.
</p><p>Every command must return some response.
</p>
<h2><span class="mw-headline" id="Script">Script</span></h2>
<h3><span class="mw-headline" id="server_macro">server macro</span></h3>
<p>server.FCMacro
</p>
<pre>import FreeCAD

# Location of the input/output files
ROOT = 'c:/tmp'


if 'server' not in dir(FreeCAD):
	# Server not running - we will start it then
	
	import os
	from threading import Event,Thread
	import Mesh
	import time

## --- brcko lib start --- ##
	import sys,os

	stdin = []
	stdinpos = []
	stdout = []

	def addstdin(path):
		global stdin,stdinpos
		if os.path.exists(path):
			pos = os.path.getsize(path)
		else:
			pos = 0
		stdin.append(path)
		stdinpos.append(pos)

	def addstdout(path):
		global stdout
		stdout.append(path)


	def getstdin():
		global stdin,stdinpos

		data = []
		for i,path in enumerate(stdin):

			if not os.path.exists(path): continue

			f = open(path)
			f.seek(stdinpos[i])
			_data = f.read()
			f.close()

			# Line-buffered
			_i = _data.rfind('\n') + 1
			_data = _data[:_i]

			data.append(_data)
			stdinpos[i] += _i

		return data

	def putstdout(data,i=0):
		global stdout

		if i &gt;= len(stdout): return
		path = stdout[i]

		if path == '-':
			sys.stdout.write(data)
		else:
			f = open(path,'a', encoding="utf-8", newline='\n')
			f.write(data)
			f.close()

## --- brcko lib end --- ##


	_cb_d = {}
	id = 0
	path = ''
	_id = 0
	_doc = 0
	_ss = 0
	_obj = 0
	_path = 0


## --- utils start --- ##

	def getDoc(n=0):
		'''Get document'''
		global _doc
		
		if n:
			try:
				doc = App.getDocument(n)
			except NameError:
				return 0
		elif _doc:
			doc = _doc
		else:
			doc = App.ActiveDocument

		return doc

	def getSS(s=0,n=0):
		'''Get spreadsheet'''
		global _ss

		doc = getDoc(n)
		if not doc: return 0

		if s:
			ss = doc.getObject(s)
		elif _ss:
			ss = _ss
		else:
			ss = doc.getObject('Spreadsheet')

		return ss

	def getObj(s=0,n=0):
		'''Get object'''
		global _obj

		doc = getDoc(n)
		if not doc: return 0

		if s:
			obj = doc.getObject(s)
		elif _obj:
			obj = _obj
		else:
			obj = doc.ActiveObject

		return obj

	def getPath(s=0, default_fn=0):
		'''Get file path (for export mainly)'''
		global _path,ROOT

		path = ''

		if not default_fn:
			default_fn='file'

		if s:
			path = s
		elif _path:
			path = _path
		else:
			path = ROOT

		path = path.replace('\\','/')# make it objectively right&nbsp;;)
		
		if os.path.isdir(path):
			path = path + '/' + default_fn
		if '.' not in path.split('/')[-1]:
			path += '.stl'

		return path

	def dlgln(ln):
		m = ''
		n = ''
		s = ''

		m = ln[0]
		ln = ln[1:]

		if ln:

			if ln[0] == ' ':
				s = ln[1:]
			else:
				if ' ' in ln:
					n,s = ln.split(' ',1)
				else:
					n = ln
		
		return m,n,s

	def register(m, fc):
		'''Register command function with respective m-code'''
		global _cb_d
		_cb_d[m] = fc

## --- utils end --- ##


## --- thread function start --- ##

	def _th(qe,id):
		global _cb_d,_id
		
		while not qe.is_set():
			for data in getstdin():
				for ln in data.split('\n'):
					if not ln: continue
					print('#D&nbsp;: server&nbsp;: got input&nbsp;:',ln)
					m,n,s = dlgln(ln)
					if m in _cb_d:
						if not _id or _id == id or _cb_d[m] == fc_selectId:
							# Only process commands if&nbsp;:
							#  id is empty
							#  id equals this instance's id
							#  we are about to execute selectId command
							_cb_d[m](m,n,s)
					else:
						print('#E&nbsp;: server&nbsp;: unknown command&nbsp;:',m)
			time.sleep(1)

## --- thread function end --- ##


## --- stdlib start --- ##
	
	def fc_getId(m,n,s):
		resp = 'i%s\n'&nbsp;% FreeCAD.server[0]
		#resp += '#I&nbsp;: server&nbsp;: fc_getId&nbsp;: done\n'
		putstdout(resp)
	
	def fc_docList(m,n,s):
		resp = ''
		
		for k,_ in App.listDocuments().items():
			resp += 'd%s\n'&nbsp;% k
		
		if not resp:
			resp += '#I&nbsp;: server&nbsp;: fc_docList&nbsp;: empty\n'
		
		putstdout(resp)

	def fc_objList(m,n,s):
		resp = ''
		doc = getDoc(n)
		
		if not doc:
			resp += '#E&nbsp;: server&nbsp;: fc_objList&nbsp;: no doc\n'
		else:
		
			for obj in doc.Objects:
				resp += 'o%s %s\n'&nbsp;% (obj.Name, obj.Label)
			
			if not resp:
				resp += '#I&nbsp;: server&nbsp;: fc_objList&nbsp;: empty\n'
		
		putstdout(resp)

	def fc_cellsList(m,n,s):
		resp = ''
		ss = getSS(s,n)

		if not ss:
			resp += '#E&nbsp;: server&nbsp;: fc_cellsList&nbsp;: no sheet\n'
		else:

			# Build list of non-empty cells
			for k in ss.getNonEmptyCells():
				v = ss.get(k)
				resp += 'c%s %s\n'&nbsp;% (k,v)
			
			if not resp:
				resp += '#I&nbsp;: server&nbsp;: fc_cellsList&nbsp;: empty\n'
		
		# Sends it
		putstdout(resp)
	

	def fc_selectId(m,n,s):
		global _id
		
		_id = n
		
		putstdout('#I&nbsp;: server&nbsp;: fc_selectId&nbsp;: done\n')
		
	def fc_selectDoc(m,n,s):
		global _doc
		
		resp = ''

		if n:
			try:
				_doc = App.getDocument(n)
			except NameError:
				resp = '#E&nbsp;: server&nbsp;: fc_selectDoc&nbsp;: no doc\n'
		else:
			_doc = 0
		
		if not resp:
			resp = '#I&nbsp;: server&nbsp;: fc_selectDoc&nbsp;: done\n'

		putstdout(resp)
	
	def fc_selectSpreadsheet(m,n,s):
		global _ss

		resp = ''
		doc = getDoc(n)

		if not doc:
			resp += '#E&nbsp;: server&nbsp;: fc_selectSpreadsheet&nbsp;: no doc\n'
		else:
		
			if s:
				_ss = doc.getObject(s)
			else:
				_ss = 0
			
			resp = '#I&nbsp;: server&nbsp;: fc_selectSpreadsheet&nbsp;: done\n'

		putstdout(resp)
	
	def fc_selectObj(m,n,s):
		global _obj

		resp = ''
		doc = getDoc(n)

		if not doc:
			resp += '#E&nbsp;: server&nbsp;: fc_selectObj&nbsp;: no doc\n'
		else:

			if s:
				_obj = doc.getObject(s)
			else:
				_obj = 0
			
			if not resp:
				resp = '#I&nbsp;: server&nbsp;: fc_selectObj&nbsp;: done\n'
	
		putstdout(resp)

	def fc_selectPath(m,n,s):
		global _path

		if s:
			_path = s
		else:
			_path = 0
	
		putstdout('#I&nbsp;: server&nbsp;: fc_selectPath&nbsp;: done\n')

	
	def fc_getCell(m,n,s):
		resp = ''
		ss = getSS(s)
		if not ss:
			resp = '#E&nbsp;: server&nbsp;: fc_getCell&nbsp;: no sheet\n'
		else:
		
			try:
				v = ss.get(n)
				resp = 'c%s %d\n'&nbsp;% (n, v)
			except ValueError:
				resp = '#E&nbsp;: server&nbsp;: fc_getCell&nbsp;: no cell\n'
				
		#resp += '#I&nbsp;: server&nbsp;: fc_getCell&nbsp;: done\n'
		putstdout(resp)
	
	def fc_setCell(m,n,s):
		resp = ''
		ss = getSS()
		if not ss:
			resp = '#E&nbsp;: server&nbsp;: fc_setCell&nbsp;: no sheet\n'
		else:
			v = ss.set(n,s)
			resp = '#I&nbsp;: server&nbsp;: fc_setCell&nbsp;: done\n'
	
		putstdout(resp)

	
	def fc_recompute(m,n,s):
		getDoc(n).recompute()
		
		putstdout('#I&nbsp;: server&nbsp;: fc_recompute&nbsp;: done\n')

	def fc_export(m,n,s):
		resp = ''
		obj = getObj(n)
		path = getPath(s, obj.Label)

		if not obj:
			resp = '#E&nbsp;: server&nbsp;: fc_export&nbsp;: no object\n'
		else:
			
			if not path:
				resp = '#E&nbsp;: server&nbsp;: fc_export&nbsp;: no path\n'
			else:
			
				if hasattr(Mesh, "exportOptions"):
					options = Mesh.exportOptions(path)
					Mesh.export([obj], path, options)
				else:
					Mesh.export([obj], path)
				
				resp += '#I&nbsp;: server&nbsp;: fc_export&nbsp;: done&nbsp;: %s\n'&nbsp;% path

		putstdout(resp)


	def fc_(m,n,s):
		resp = ''
		putstdout(resp)

	def fc_(m,n,s):
		resp = ''
		putstdout(resp)

	def fc_(m,n,s):
		resp = ''
		putstdout(resp)

## --- stdlib end --- ##


## --- Extensions start --- ##
## --- Extensions end --- ##


	# Register all command functions with their codes
	
	register('I', fc_getId)
	register('D', fc_docList)
	register('O', fc_objList)
	register('C', fc_cellsList)

	register('i', fc_selectId)
	register('d', fc_selectDoc)
	register('s', fc_selectSpreadsheet)
	register('o', fc_selectObj)
	register('p', fc_selectPath)
	
	register('@', fc_getCell)
	register('!', fc_setCell)
	
	register('r', fc_recompute)
	register('e', fc_export)
	
	#register('', fc_)


## --- Extensions registration start --- ##

	#register('', fc_)

## --- Extensions registration end --- ##


	# Setup brcko lib
	path = os.path.abspath(ROOT)
	# in &lt;-&gt; in
	# out &lt;-&gt; out
	addstdin('%s/server.stdin' %path)
	addstdout('%s/server.stdout' %path)


	# Little bit of flexing O:)
	genid = lambda seed,lvl: 'QWERTYUIOPASDFGHJKLZXCVBNM'[seed%26]+genid((seed*12345)%56789,lvl-1) if lvl&gt;0 else ''
	id = genid(int(time.time()*1000),8)
	
	qe = Event()
	th = Thread(target=_th,args=(qe,id))

	FreeCAD.server = (id,qe,th)
	th.start()

	print('#I&nbsp;: server&nbsp;: started&nbsp;:',id)

else:
	# Server is running - let's stop it now
	
	(id,qe,th) = FreeCAD.server

	qe.set()
	del(FreeCAD.server)

	print('#I&nbsp;: server&nbsp;: stopped')</pre>
<h3><span class="mw-headline" id="client_script">client script</span></h3>
<p>freecad-ctl.py
</p>
<pre>#!/usr/bin/python3

import os
import time


# Location of the input/output files
ROOT = 'c:/tmp'


## --- brcko lib start --- ##
import sys,os

stdin = []
stdinpos = []
stdout = []

def addstdin(path):
	global stdin,stdinpos
	if os.path.exists(path):
		pos = os.path.getsize(path)
	else:
		pos = 0
	stdin.append(path)
	stdinpos.append(pos)

def addstdout(path):
	global stdout
	stdout.append(path)


def getstdin():
	global stdin,stdinpos

	data = []
	for i,path in enumerate(stdin):

		if not os.path.exists(path): continue

		f = open(path)
		f.seek(stdinpos[i])
		_data = f.read()
		f.close()

		# Line-buffered
		_i = _data.rfind('\n') + 1
		_data = _data[:_i]

		data.append(_data)
		stdinpos[i] += _i

	return data

def putstdout(data,i=0):
	global stdout

	if i &gt;= len(stdout): return
	path = stdout[i]

	if path == '-':
		sys.stdout.write(data)
	else:
		f = open(path,'a', encoding="utf-8", newline='\n')
		f.write(data)
		f.close()

## --- brcko lib end --- ##


# Process command line arguments

cmd = ''

if len(sys.argv) &gt; 1:
	# Use command line arguments to build command script
	
	for a in sys.argv[1:]:
		if a == '-':
			# Read list of commands from (real) stdin
			cmd + sys.stdin.read().replace('\r','\n')
		else:
			cmd += a
		cmd += '\n'
#else:
	# Default&nbsp;: get document list

#	cmd = 'D\n'


# Setup brcko lib
path = os.path.abspath(ROOT)
# in &lt;-&gt; out
# out &lt;-&gt; in
addstdin('%s/server.stdout' %path)
addstdout('%s/server.stdin' %path)


# Send command script
if cmd:
	putstdout(cmd)

try:

	# Wait for response (indicated by file size change / file creation)
	if not os.path.exists(stdin[0]):
		while not os.path.exists(stdin[0]):
			time.sleep(.1)
	else:
		sz = os.path.getsize(stdin[0])
		while sz == os.path.getsize(stdin[0]):
			time.sleep(.1)

	# Just to be sure write ended
	time.sleep(.5)

except KeyboardInterrupt:
	sys.exit()

# Print response
for data in getstdin():
	print(data)</pre>
<!-- 
NewPP limit report
Cached time: 20260130155305
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc]
CPU time usage: 0.022 seconds
Real time usage: 0.026 seconds
Preprocessor visited node count: 179/1000000
Post&#8208;expand include size: 1788/2097152 bytes
Template argument size: 10084/2097152 bytes
Highest expansion depth: 5/100
Expensive parser function count: 11/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 12011/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    6.640      1 -total
 40.66%    2.700      1 Template:Macro
 30.34%    2.015      2 Template:MacroCode
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:412380-0!canonical and timestamp 20260130155315 and revision id 1746050. Rendering was triggered because: edit-page
 -->
</div>
</div><script src="site.js"></script>