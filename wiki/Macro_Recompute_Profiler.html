<link href="site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Macro Recompute Profiler</span></h1><?xml encoding="UTF-8"><div class="mw-parser-output"><div class="mw-pt-languages noprint" lang="en" dir="ltr"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><span class="mw-pt-languages-ui mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" lang="en" dir="ltr">English</span></li>
<li><a href="fr/Macro_Recompute_Profiler.html" class="mw-pt-progress mw-pt-progress--complete" title="Macro Recompute Profiler (100% translated)" lang="fr" dir="ltr">fran&ccedil;ais</a></li>
<li><a href="it/Macro_Recompute_Profiler.html" class="mw-pt-progress mw-pt-progress--complete" title="Macro Recompute Profiler (100% translated)" lang="it" dir="ltr">italiano</a></li>
<li><a href="pl/Macro_Recompute_Profiler.html" class="mw-pt-progress mw-pt-progress--stub" title="Makrodefinicja: Recompute Profiler (5% translated)" lang="pl" dir="ltr">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="index.php?title=Macro_Recompute_Profiler.png&amp;filetimestamp=20190712160159&amp;.html" class="mw-file-description"><img src="File/Macro_Recompute_Profiler.png" decoding="async" width="32" height="32"></a></span><span> </span>
Macro Recompute Profiler
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">This macro is to help you find, what features cause long delays in updates to the project. It performs a recompute, measuring the time it takes to recompute each feature.<br><br>Macro version: 0.1<br>Last modified: 2017-04-03<br>FreeCAD version: 0.17.10644 and above<br>Download: <a rel="nofollow" class="external text" href="https://www.freecadweb.org/wiki/images/c/ca/Macro_Recompute_Profiler.png">ToolBar Icon</a><br>Author: DeepSOIC<br>
</td></tr>
<tr>
<th class="ctOdd">Author
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="User;DeepSOIC.html" title="User:DeepSOIC">DeepSOIC</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><a rel="nofollow" class="external text" href="https://www.freecadweb.org/wiki/images/c/ca/Macro_Recompute_Profiler.png">ToolBar Icon</a>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes">Macros recipes</a><br><a href="How_to_install_macros.html" title="How to install macros">How to install macros</a><br><a href="Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a>
</td></tr>
<tr>
<th class="ctOdd">Macro Version
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Date last modified
</th></tr>
<tr>
<td class="ctEven macro-date">2017-04-03
</td></tr>
<tr>
<th class="ctOdd">FreeCAD Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">0.17.10644 and above
</td></tr>
<tr>
<th class="ctOdd">Default shortcut
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">See also
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><meta property="mw:PageProp/toc">
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>This macro is to help you find, what features cause long delays in updates to the project. It performs a recompute, measuring the time it takes to recompute each feature.
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<p>This macro requires FreeCAD no less than 0.17.10644
</p><p>Save the macro to a file.
</p><p>1. Open your project
</p><p>2. Right-click an object in model tree, pick "Mark to recompute"
</p><p>3. Run this macro.
</p><p>A progress bar will appear. As each object is recomputed, a line is printed to Report View, containing the time and the label of the object. If any object fails to recompute, the macro will display an error message and terminate the process.
</p>
<h2><span class="mw-headline" id="Macro">Macro</span></h2>
<p>ToolBar Icon
<span class="mw-default-size" typeof="mw:File"><a href="index.php?title=Macro_Recompute_Profiler.png&amp;filetimestamp=20190712160159&amp;.html" class="mw-file-description"><img src="File/Macro_Recompute_Profiler.png" decoding="async" width="64" height="64"></a></span>
</p><p><b>RecomputeProfiler.FCMacro</b>
</p>
<pre>__Title__="Macro Recompute Profiler"
__Author__ = "DeepSOIC"
__Version__ = "0.1"
__Date__    = "03.04.2017"

__Comment__ = "Measures time it takes to recmpute features in a project"
__Wiki__ = "https://www.freecadweb.org/wiki/index.php?title=Macro_Recompute_Profiler"
__Help__ = "Right-click an object, and pick 'Mark to recompute', then run this macro. This will only profile recomputing the subgraph. To profile the whole project, right-click the project in tree view, and pick 'Mark to recompute', then run this macro. Results will be printed to report view."
__Status__ = "experimental"
__Requires__ = "freecad 0.17.10644"
__Communication__ = "https://forum.freecadweb.org/memberlist.php?mode=viewprofile&amp;u=3888" 

import FreeCAD as App

import FreeCADGui as Gui

class ExecutionError(Exception):
    pass

class CancelError(Exception):
    pass

def execute(feature):
    feature.recompute()
    if 'Invalid' in feature.State:
        raise ExecutionError("Feature '{label}' failed to recompute".format(label= feature.Label))

def msgbox(title, text):
    from PySide import QtGui
    mb = QtGui.QMessageBox()
    mb.setIcon(mb.Icon.Information)
    mb.setText(text)
    mb.setWindowTitle(title)
    mb.exec_()

def log(string):
    App.Console.PrintWarning(string+"\n")

def getAllDependent(feat_list):
    '''getAllDependent(feat_list): gets all features that depend on features in feat_list, directly or indirectly.
    Returns a set. Features from feat_list are not included, unless there are interdependencies between them.'''

    list_traversing_now = feat_list
    set_of_deps = set()
    list_of_deps = []

    while len(list_traversing_now) &gt; 0:
        list_to_be_traversed_next = []
        for feat in list_traversing_now:
            for dep in feat.InList:
                if not (dep in set_of_deps):
                    set_of_deps.add(dep)
                    list_of_deps.append(dep)
                    list_to_be_traversed_next.append(dep)

        list_traversing_now = list_to_be_traversed_next

    return set_of_deps


def run():
    touched = [obj for obj in App.ActiveDocument.Objects if 'Touched' in obj.State]

    if len(touched) == 0:
        App.ActiveDocument.RecomputesFrozen = True
        msgbox("Macro Recompute Profiler", "Project was switched to suspend recomputes. Please modify an object that triggers a recompute, and run this macro again. The macro will perform a step-by-step recompute, and measure the time it takes to recompute features.")
        return

    log("{n} features are touched".format(n= len(touched)))

    log("Generating execution order...")

    to_be_executed = set.union(getAllDependent(touched), set(touched))
    log("Number of features to execute: {n}".format(n= len(to_be_executed)))

    exec_list = []
    for obj in App.ActiveDocument.TopologicalSortedObjects[::-1]:
        if obj in to_be_executed:
            exec_list.append(obj)
    assert(len(exec_list) == len(to_be_executed))
    n = len(exec_list)

    log("Execution order:")
    for obj in exec_list:
        log("    "+obj.Label)


    import PySide
    progress = PySide.QtGui.QProgressDialog(u"Preparing to recompute....", u"Abort", 0, n+1)
    progress.setModal(True)
    progress.show()
    
    try:
        log("Recomputing... (time in seconds, label)")
        import time
        for obj in exec_list:
            progress.setValue(progress.value()+1)
            progress.setLabelText("Recomputing {feature}...".format(feature= obj.Label))
            if progress.wasCanceled():
                raise CancelError()

            time_start = time.time()
            try:
                execute(obj)
            finally:
                exec_time = time.time()-time_start
                log("\t{time}\t{label}".format(time= exec_time, label= obj.Label))

        progress.setValue(n+1)
        msgbox("Macro Recompute Profiler", "Recompute completed. Results are in report view.")

        for obj in exec_list:
            obj.purgeTouched()

    except Exception as err:
        msgbox("Macro Recompute Profiler", "An error occured: {err}".format(err= str(err)))
    finally:
        progress.hide()
        App.ActiveDocument.RecomputesFrozen = False

run()</pre>
<h2><span class="mw-headline" id="Post-processing_results">Post-processing results</span></h2>
<p>The output of the macro will be interleaved with general messages produced by recomputing features. It generally looks like this:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">Recomputing</span><span class="o">...</span> <span class="p">(</span><span class="n">time</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span>
	<span class="mf">0.0199999809265</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span><span class="mi">001</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch013</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch011</span>
	<span class="mf">0.0</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.0</span>	<span class="n">Sketch008</span>
	<span class="mf">0.130000114441</span>	<span class="n">LinearArray</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="o">...</span>
</pre></div>
<p>The result lines have an easy signature to separate them off: they start with a tab. So, if you copy-paste the whole chunk to a spreadsheet program, generic messages will end up in column 1, while the results are in columns 2 and 3. So, you can sort by column 2, to get a nice table like that:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="mf">0.59100008</span>	<span class="n">Slice</span>
<span class="mf">0.352999926</span>	<span class="n">Populate</span> <span class="n">LinearArray</span> <span class="k">with</span> <span class="n">Compound</span>
<span class="mf">0.160000086</span>	<span class="n">CompoundFilter</span>
<span class="mf">0.138999939</span>	<span class="n">Cut</span>
<span class="mf">0.130000114</span>	<span class="n">LinearArray</span>
<span class="mf">0.108999968</span>	<span class="n">Fusion</span>
<span class="mf">0.069999933</span>	<span class="n">Moved</span> <span class="n">CompoundFilter</span>
<span class="mf">0.067000151</span>	<span class="n">Module</span> <span class="o">-</span> <span class="n">spokes</span>
<span class="mf">0.029999971</span>	<span class="n">Sweep</span>
<span class="mf">0.019999981</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span><span class="mi">001</span>
<span class="mf">0.010999918</span>	<span class="n">ArrayFilter003</span>
<span class="o">...</span>
</pre></div>
<p>(For MS-Excel, pasting right after copying text from report view doesn't split it into columns, don't know why... pasting the text to Notepad and re-copying it from Notepad and pasting to excel helps.)
</p>
<h2><span class="mw-headline" id="FreeCAD_version">FreeCAD version</span></h2>
<p>This macro requires FreeCAD no less than 0.17.10644, which was the version where App.ActiveDocument.RecomputesFrozen became available. It might be functional with a bit older FreeCAD, but certainly won't work with v0.16.
</p><p>This macro was created using this version of FreeCAD:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span> <span class="mi">10</span>
<span class="n">Word</span> <span class="n">size</span> <span class="n">of</span> <span class="n">OS</span><span class="p">:</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Word</span> <span class="n">size</span> <span class="n">of</span> <span class="n">FreeCAD</span><span class="p">:</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Version</span><span class="p">:</span> <span class="mf">0.17.10665</span> <span class="p">(</span><span class="n">Git</span><span class="p">)</span>
<span class="n">Build</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Release</span>
<span class="n">Branch</span><span class="p">:</span> <span class="n">master</span>
<span class="n">Hash</span><span class="p">:</span> <span class="mi">47847513</span><span class="n">a85ff6615774ef628230f79e37471daf</span>
<span class="n">Python</span> <span class="n">version</span><span class="p">:</span> <span class="mf">2.7.8</span>
<span class="n">Qt</span> <span class="n">version</span><span class="p">:</span> <span class="mf">4.8.7</span>
<span class="n">Coin</span> <span class="n">version</span><span class="p">:</span> <span class="mf">4.0.0</span><span class="n">a</span>
<span class="n">OCC</span> <span class="n">version</span><span class="p">:</span> <span class="mf">7.0.0</span>
</pre></div>
<!-- 
NewPP limit report
Cached time: 20250705101257
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc, no&#8208;toc&#8208;conversion]
CPU time usage: 0.080 seconds
Real time usage: 0.092 seconds
Preprocessor visited node count: 158/1000000
Post&#8208;expand include size: 2516/2097152 bytes
Template argument size: 6004/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 5/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 11978/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%   10.602      1 -total
 40.35%    4.278      1 Template:Macro
 31.51%    3.341      3 Template:Code
 23.68%    2.511      1 Template:MacroCode
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:79620-0!canonical and timestamp 20250705101257 and revision id 1601826. Rendering was triggered because: edit-page
 -->
</div>
</div><script src="site.js"></script>