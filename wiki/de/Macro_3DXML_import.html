<link href="../site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Macro 3DXML import/de</span></h1><?xml encoding="UTF-8"><div class="mw-content-ltr mw-parser-output" lang="de" dir="ltr"><div class="mw-pt-languages noprint navigation-not-searchable" lang="en" dir="ltr"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a href="../index.php?title=Special;Translate&amp;group=page-Macro+3DXML+import&amp;language=&amp;task=view.html" class="new" title="Start translation for this language" lang="" dir="ltr"></a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" lang="de" dir="ltr">Deutsch</span></li>
<li><a href="../Macro_3DXML_import.html" class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" title="Macro 3DXML import (100% translated)" lang="en" dir="ltr">English</a></li>
<li><a href="../fr/Macro_3DXML_import.html" class="mw-pt-progress mw-pt-progress--complete" title="Macro 3DXML import (100% translated)" lang="fr" dir="ltr">fran&ccedil;ais</a></li>
<li><a href="../pl/Macro_3DXML_import.html" class="mw-pt-progress mw-pt-progress--low" title="Makrodefinicja: Import 3DXML (7% translated)" lang="pl" dir="ltr">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="../index.php?title=Text-x-python.png&amp;filetimestamp=20121224162851&amp;.html" class="mw-file-description" title="Generisches Makro-Symbol Erstellen Sie Ihr pers&ouml;nliches Symbol mit demselben Namen des Makros"><img alt="Generisches Makro-Symbol Erstellen Sie Ihr pers&ouml;nliches Symbol mit demselben Namen des Makros" src="../File/Text-x-python.png" decoding="async" width="32" height="32" class="mw-file-element" data-file-width="48" data-file-height="48"></a></span><span> </span>
Makro 3DXML-Import
</p>
</td></tr>
<tr>
<th class="ctOdd">Beschreibung
</th></tr>
<tr>
<td class="ctEven left macro-description">Importiert eine 3DXML-ASCII Datei in FreeCAD.<br><br>Versionsmakro&nbsp;: 0.1<br>Datum der letzten &Auml;nderung&nbsp;: 2021-10-03<br>FreeCAD version&nbsp;: -<br>Autor: heda<br>
</td></tr>
<tr>
<th class="ctOdd">Autor
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="../index.php?title=User;Heda&amp;action=edit&amp;redlink=1.html" class="new" title="User:Heda (page does not exist)">heda</a>
</td></tr>
<tr>
<th class="ctOdd">Herunterladen
</th></tr>
<tr>
<td class="ctEven macro-download"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../de/Macros_recipes.html" title="Macros recipes/de">Makros Rezepte</a><br><a href="../de/How_to_install_macros.html" title="How to install macros/de">Wie man Makros installiert</a><br><a href="../de/Customize_Toolbars.html" title="Customize Toolbars/de">Symbolleisten anpassen</a>
</td></tr>
<tr>
<th class="ctOdd">Macro-Version
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Datum der letzten &Auml;nderung
</th></tr>
<tr>
<td class="ctEven macro-date">2021-10-03
</td></tr>
<tr>
<th class="ctOdd">FreeCAD-Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">-
</td></tr>
<tr>
<th class="ctOdd">Standardverkn&uuml;pfung
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Siehe auch
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><meta property="mw:PageProp/toc">
</td></tr>
</tbody></table>
<p><span id="Description"></span>
</p>
<h2><span class="mw-headline" id="Beschreibung">Beschreibung</span></h2>
<p>Dieses Makro importiert eine 3DXML-ASCII-Datei mit Optionen zum Einf&uuml;gen von Kanten und/oder Netzen. Es gibt weitere Arten von 3DXML-Dateien neben dem ASCII-Typ, andere Arten k&ouml;nnen mit diesem Makro nicht importiert werden.
</p><p>Das Makro wurde nur an einer Datei getestet, die implementierten Funktionen beschr&auml;nken sich auf die in dieser Datei verf&uuml;gbaren Funktionen. Wenn weitere Testdateien zur Verf&uuml;gung gestellt werden, k&ouml;nnte das Makro m&ouml;glicherweise um zus&auml;tzliche Funktionen erweitert werden. Jeder kann das Makro &auml;ndern und verbessern, am besten hier im Wiki. Weitere Informationen findet man im <code>docstring</code> des Makros.
</p><p><span id="Usage"></span>
</p>
<h2><span class="mw-headline" id="Anwendung">Anwendung</span></h2>
<p>Makro ausf&uuml;hren und eine Datei ausw&auml;hlen.
</p><p><span id="Install"></span>
</p>
<h2><span class="mw-headline" id="Installieren">Installieren</span></h2>
<p>Mit dem AddonManager.
</p><p><span id="Link"></span>
</p>
<h2><span class="mw-headline" id="Verweis">Verweis</span></h2>
<p>Forum: Kein spezifischer Faden, aber der Ursprung liegt in diesem  <a rel="nofollow" class="external text" href="https://forum.freecad.org/viewtopic.php?f=8&amp;t=28199">Forenbeitrag</a>.
</p>
<h2><span class="mw-headline" id="Version">Version</span></h2>
<p>v0.1 2021-10-03&nbsp;: Erstver&ouml;ffentlichung
</p>
<h2><span class="mw-headline" id="Code">Code</span></h2>
<p><b>Macro_3DXML_import.FCMacro</b>
</p>
<pre>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# ***************************************************************************
# *   Copyright (c) 2021 heda &lt;heda @ freecad forum&gt;                        *
# *                                                                         *
# *   This file is part of the FreeCAD CAx development system.              *
# *                                                                         *
# *   This program is free software; you can redistribute it and/or modify  *
# *   it under the terms of the GNU Lesser General Public License (LGPL)    *
# *   as published by the Free Software Foundation; either version 2 of     *
# *   the License, or (at your option) any later version.                   *
# *   for detail see the LICENCE text file.                                 *
# *                                                                         *
# *   This program is distributed in the hope that it will be useful,       *
# *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
# *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
# *   GNU Library General Public License for more details.                  *
# *                                                                         *
# *   You should have received a copy of the GNU Library General Public     *
# *   License along with this program; if not, write to the Free Software   *
# *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  *
# *   USA                                                                   *
# *                                                                         *
# ***************************************************************************


__Name__ = '3DXML_import'
__Comment__ = 'Imports a 3DXML-ascii file to FreeCAD'
__Author__ = 'heda @ fc-forum'
__Version__ = '0.1'
__Date__ = '2021-10-03'
__License__ = 'LGPL-2.0-or-later'
__Web__ = ''
__Wiki__ = 'https://wiki.freecad.org/Macro_3DXML_import'
__Icon__ = ''
__Help__ = 'Launch macro and select file.'
__Status__ = 'Stable'
__Requires__ = 'tested on FreeCAD v0.19'
__Communication__ = 'forum'
__Files__ = ''


__doc__ = """
The 3DXML file format allows for multiple types of representations.
This macro is limited to human readable content in the files,
i.e. the ascii tesselated type of geometry definition.
This type of geometry definition includes polylines as edges of geometry,
and meshes (like stl files).

The macro in current state requires a readable xml-file of type ".3DRep".

Import of edges is by default off, since that is the operation taking the
longest time.

It is recommended to run a mesh analysis after import to for example
remove duplicate points or correct flipped normals.

This macro is created using only one reference file (with only "strips" as
facets), thus it's applicability on other .3DRep files is currently unknown.
If other test files are made available, the macro can be updated.
"""

import FreeCAD as App
import Part, Mesh
from PySide import QtGui
import xml.etree.ElementTree as ET

IMPORT_EDGES, MERGE_EDGES = False, False
IMPORT_MESHES, MERGE_MESHES = True, True

filename, filt = QtGui.QFileDialog.getOpenFileName(filter='*.3DRep')

if not filename:
    raise UserWarning('Need to select a 3DRep file.')

print('Importing: {}'.format(filename))
doc = App.ActiveDocument

tree = ET.parse(filename)
root = tree.getroot()

# get namespaces from xml
ns = dict([node for _, node in
           ET.iterparse(filename, events=['start-ns'])])
if ns.get('')&nbsp;!= 'http://www.3ds.com/xsd/3DXML':
    raise UserWarning('did not find expected namespace, file malformed?')
ns.update({'3dx':ns.get('')})


def parse_verts(vertbuffer):
    def floatify(xyz):
        return tuple((float(i) for i in xyz.split()))
    return [floatify(v) for v in vertbuffer.split(',')]

def parse_strips(strips):
    return (tuple(int(i) for i in strip.split())
            for strip in strips.split(','))

def make_mesh(element):
    Faces, VertexBuffer, SurfaceAttributes = list(element)
    Color = Faces.find('.//3dx:Color', ns)
    RGBA = tuple((float(i) for i in tuple(Color.attrib.values())[1:]))
    Face = Faces.find('.//3dx:Face', ns)
    strips = Face.get('strips')
    facets = list()
    if strips:
        Positions, Normals = list(VertexBuffer)
        facetverts = fv = parse_verts(Positions.text)
        for strip in parse_strips(strips):
            facetidx = zip(strip, strip[1:], strip[2:])
            facets += [tuple(fv[i] for i in pidx) for pidx in facetidx]
    else:
        print('face type undefined')
    return Mesh.Mesh(facets), RGBA


for BagRepType in root.findall('3dx:Root/3dx:Rep', ns):
    edges, meshes = list(), list()
    for PolygonalRepType in BagRepType:
        if PolygonalRepType.find('./3dx:Edges', ns):
            if not IMPORT_EDGES:
                continue
            Edges = PolygonalRepType.find('./3dx:Edges', ns)
            for polyline in Edges.findall('./3dx:Polyline', ns):
                verts = parse_verts(polyline.get('vertices'))
                edges.append(Part.makePolygon(verts))
                
        elif PolygonalRepType.find('./3dx:Faces', ns):
            print('  found face element')
            if not IMPORT_MESHES:
                continue
            mesh = make_mesh(PolygonalRepType)
            meshes.append(mesh)

    if edges:
        print('  creating edges')
        edgegroup = doc.addObject('App::DocumentObjectGroup','Edges')
        wires = list()
        if MERGE_EDGES:
            _edges = list()
            for _edge in edges:
                _edges += _edge.Edges
            for swire in Part.sortEdges(_edges):
                wire = Part.Wire(swire)
                obj = doc.addObject('Part::Feature', 'Edge')
                obj.Shape = wire
                wires.append(obj)
        else:
            for edge in edges:
                obj = doc.addObject('Part::Feature', 'Edge')
                obj.Shape = edge
                wires.append(obj)
        edgegroup.addObjects(wires)

    if meshes:
        print('  creating meshes')
        meshgroup = doc.addObject('App::DocumentObjectGroup','Meshes')
        meshobjs = list()
        if MERGE_MESHES:
            mesh_assembled = Mesh.Mesh()
            for mesh, RGBA in meshes:
                mesh_assembled.addMesh(mesh)
            obj = doc.addObject('Mesh::Feature', 'Mesh')
            obj.Mesh = mesh_assembled
            obj.ViewObject.ShapeColor = RGBA
            meshobjs.append(obj)
        else:
            for mesh, RGBA in meshes:
                obj = doc.addObject('Mesh::Feature', 'Mesh')
                obj.Mesh = mesh
                obj.ViewObject.ShapeColor = RGBA
                meshobjs.append(obj)
        meshgroup.addObjects(meshobjs)

doc.recompute()
print('... completed import')

# end</pre>
<!-- 
NewPP limit report
Cached time: 20251021140147
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc]
CPU time usage: 0.060 seconds
Real time usage: 0.083 seconds
Preprocessor visited node count: 103/1000000
Post&#8208;expand include size: 2279/2097152 bytes
Template argument size: 7042/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 2/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 7915/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    7.838      1 -total
 62.03%    4.862      1 Template:Macro/de
 18.51%    1.451      1 Template:MacroCode
 16.61%    1.302      1 Template:Incode
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:392320-0!canonical and timestamp 20251021140147 and revision id 1669773. Rendering was triggered because: api-parse
 -->
</div>
</div><script src="../site.js"></script>